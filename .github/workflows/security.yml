name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

jobs:
  # Slither Static Analysis
  slither:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Slither
        run: |
          pip install slither-analyzer
      
      - name: Run Slither on packages/core
        working-directory: packages/core
        run: |
          slither . --json - --exclude-dependencies --exclude-informational --exclude-optimization --exclude-low | tee slither-report.json || true
        continue-on-error: true
      
      - name: Run Slither on examples
        working-directory: examples/sdk/basic-strategy
        run: |
          slither contracts/ --json - --exclude-dependencies --exclude-informational --exclude-optimization --exclude-low | tee slither-report.json || true
        continue-on-error: true
      
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: packages/core/slither-report.json
          wait-for-processing: true
        continue-on-error: true
      
      - name: Check for high severity issues
        run: |
          if [ -f "packages/core/slither-report.json" ]; then
            HIGH_ISSUES=$(cat packages/core/slither-report.json | jq '[.results.detectors[] | select(.impact == "High")] | length')
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "::error::Found $HIGH_ISSUES high severity issues"
              exit 1
            fi
          fi
        continue-on-error: true

  # npm Audit
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - examples/sdk/basic-strategy
          - examples/sdk/rebalancing-strategy
          - packages/test
          - packages/cli
    
    defaults:
      run:
        working-directory: ${{ matrix.project }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project }}/package-lock.json
        continue-on-error: true
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > audit-report.json || true
        continue-on-error: true
      
      - name: Check for critical vulnerabilities
        run: |
          if [ -f "audit-report.json" ]; then
            CRITICAL=$(cat audit-report.json | jq -r '.metadata.vulnerabilities.critical // 0')
            HIGH=$(cat audit-report.json | jq -r '.metadata.vulnerabilities.high // 0')
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "::error::Found $CRITICAL critical and $HIGH high vulnerabilities"
              echo "Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
              echo "High: $HIGH" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi
        continue-on-error: true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report-${{ matrix.project }}
          path: ${{ matrix.project }}/audit-report.json
          retention-days: 30
        continue-on-error: true

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [slither, npm-audit, codeql]
    if: always()
    
    steps:
      - name: Security Summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Slither static analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ npm audit completed" >> $GITHUB_STEP_SUMMARY
          echo "✅ CodeQL analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the results above for any security issues." >> $GITHUB_STEP_SUMMARY
